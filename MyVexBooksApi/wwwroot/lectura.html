<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lectura</title>
    <link rel="stylesheet" href="estilos.css" />
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="iconos/512.png" />
</head>
<body>
    <header class="Encabezado">
        <img src="img/logo.png" class="logo" id="logo">

        <div class="DivBusqueda">
            <img src="img/lupa.png" class="lupa">
            <input type="text" placeholder="Buscar" id="inputBusqueda">
        </div>

        <div class="divGeneros">
            <button class="Generos" id="btnGeneros">
                <span class="flecha">&#9660;</span>
                <span>Géneros</span>
            </button>

            <div class="menuGeneros" id="menuGeneros">
         
            </div>
        </div>

        <div class="divNotificaciones">
            <div class="iconoCampana">
                <img src="img/notificacion.png" class="notificacion" id="btnNoti">
                <span class="puntoRojo" id="puntoNuevo"></span>
            </div>

            <div class="menuNotificaciones" id="panelNoti">
                <h3>Notificaciones</h3>
                <p class="sinMensajes" id="sinMensajes">No hay mensajes nuevos</p>
                <div class="listaMensajes" id="listaMensajes">
                    <p class="conMensajes" id="conMensajes"></p>
                </div>
            </div>
        </div>

        <img src="fotoPerfil/perfil.png" class="perfil" id="perfil">
    </header>

    <main class="mainLectura">
        <div class="divLectura">
            <div class="divHeader">
                <h2>Prólogo: Cuerda de presos</h2>
                <span class="spanLibroCap">
                    <img src="img/likes.png" class="likesCap" id="likes" />
                    <span id="likesNumero">0</span>
                </span>

                <img src="img/lista.png" class="btnLista" />
            </div>

            <div class="divTexto">
                <p id="textoLectura"></p>
            </div>

            <button class="continuar">continuar</button>

            <div class="divZoom">
                <img src="img/zoom in.png" id="btnAumentar" />
                <img src="img/zoom out.png" id="btnDisminuir" />
            </div>

            <aside class="sidebar" id="sidebar">
                <img src="img/lista.png" class="btnListaSidebar" />
                <img src="" class="portada">
                <h4>Contenido</h4>

                <ul class="listaCapitulos">
                </ul>
            </aside>
        </div>
    </main>

    <script>

        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("/sw.js")
                .then(() => console.log("SW registrado"))
                .catch(err => console.error(err));
        }

        const token = localStorage.getItem("token");
        if (!token) window.location.href = "index.html";

        const headers = { "Content-Type": "application/json", "Authorization": `Bearer ${token}` };

       

        const params = new URLSearchParams(window.location.search);
        const idParte = params.get("id");

        let listaPartes = []; 

        async function cargarParte() {
            try {
                // Obtener la parte
                const respParte = await fetch(`https://myvexbooks2.duckdns.org/api/Libros/parte/${idParte}`, { headers });
                const parte = await respParte.json();

                // Título de la parte
                const divHeader = document.querySelector(".divHeader h2");
                divHeader.textContent = parte.nombreParte || `Parte ${parte.numeroParte}`;

                // Contenido
                const divTexto = document.querySelector(".divTexto p");
                divTexto.innerHTML = parte.contenido;

                // Likes
                const spanLikes = document.getElementById("likes");
                const likesBackend = parte.likes ?? 0;
                document.getElementById("likesNumero").textContent = likesBackend;

                await inicializarLikes(likesBackend);

                await cargarListaPartes(parte.idLibro);

          
                const respLibro = await fetch(`https://myvexbooks2.duckdns.org/api/Libros/${parte.idLibro}`, { headers });
                const libro = await respLibro.json();

                const imgPortada = document.querySelector(".portada");
                imgPortada.src = libro.portadaURL || "img/libro.jpg"; 

            } catch (err) {
                console.error("Error cargando parte:", err);
            }
        }



        async function cargarListaPartes(idLibro) {
            try {
                const resp = await fetch(`https://myvexbooks2.duckdns.org/api/Libros/${idLibro}`, { headers });
                const libro = await resp.json();

                listaPartes = libro.partes || [];

                const lista = document.querySelector(".listaCapitulos");
                lista.innerHTML = "";

                listaPartes.forEach(p => {
                    const li = document.createElement("li");
                    li.textContent = p.nombreParte && p.nombreParte.trim() !== ""
                        ? p.nombreParte
                        : `Parte ${p.numeroParte}`;

                    li.onclick = () => window.location.href = `lectura.html?id=${p.idParte}`;
                    lista.appendChild(li);
                });

       
                configurarContinuar();

            } catch (err) {
                console.error("Error cargando lista de partes:", err);
            }
        }

 
        function configurarContinuar() {
            const btn = document.querySelector(".continuar");
            const indiceActual = listaPartes.findIndex(p => p.idParte == idParte);

            btn.onclick = () => {
                const siguiente = listaPartes[indiceActual + 1];
                if (siguiente) {
                    window.location.href = `lectura.html?id=${siguiente.idParte}`;
                } else {
                    alert("¡Has llegado al final del libro!");
                }
            };
        }

    
        async function cargarGeneros() {
            try {
                const resp = await fetch("https://myvexbooks2.duckdns.org/api/Libros/generos", { headers });
                const generos = await resp.json();

                const menu = document.getElementById("menuGeneros");
                menu.innerHTML = "";
                generos.forEach(g => {
                    const btn = document.createElement("button");
                    btn.textContent = g;
                    btn.onclick = () => window.location.href = `./generos.html?genero=${encodeURIComponent(g)}`;
                    menu.appendChild(btn);
                });
            } catch (err) {
                console.error("Error cargando géneros:", err);
            }
        }

        function configurarBuscador() {
            const input = document.getElementById("inputBusqueda");
            let timeout = null;

            input.addEventListener("input", () => {
                const texto = input.value.trim();
                clearTimeout(timeout);
                if (!texto) {
                    const cont = document.getElementById("resultadosBusqueda");
                    if (cont) cont.remove();
                    return;
                }
                timeout = setTimeout(() => buscarLibros(texto), 300);
            });
        }

        async function buscarLibros(texto) {
            try {
                const resp = await fetch(`https://myvexbooks2.duckdns.org/api/Libros/buscar/${texto}`, { headers });
                const libros = await resp.json();
                mostrarResultadosBusqueda(libros);
            } catch (err) {
                console.error("Error buscando:", err);
            }
        }

        function mostrarResultadosBusqueda(libros) {
            let cont = document.getElementById("resultadosBusqueda");
            if (!cont) {
                cont = document.createElement("div");
                cont.id = "resultadosBusqueda";
                document.querySelector("main").prepend(cont);
            }
            cont.innerHTML = "<h2>Resultados</h2>";
            if (!libros.length) { cont.innerHTML += "<p>No hay resultados.</p>"; return; }
            libros.forEach(l => {
                cont.innerHTML += `
                 <div class="divRB"
                      onclick="window.location.href='libro.html?id=${l.idLibro}'">
                     <img class="imgRB" src="${l.portadaURL}" >
                     <div class="divBookRB">
                         <p><b>${l.titulo}</b></p>
                         <p class="pAutorRB">${l.autor}</p>
                         <p class="pGeneroRB">${l.genero}</p>
                     </div>
                 </div>`;
            });
        }


        function configurarEventosEstaticos() {
            // Menú de géneros
            const btnGen = document.getElementById("btnGeneros");
            const menuGen = document.getElementById("menuGeneros");
            const flecha = document.querySelector(".flecha");

            btnGen.addEventListener("click", () => {
                menuGen.style.display = menuGen.style.display === "grid" ? "none" : "grid";
                flecha.classList.toggle("arriba");
            });

            const btnNoti = document.getElementById("btnNoti");
            const panelNoti = document.getElementById("panelNoti");
            const puntoNuevo = document.getElementById("puntoNuevo");

            btnNoti.addEventListener("click", () => {
                panelNoti.style.display = panelNoti.style.display === "block" ? "none" : "block";
                if (puntoNuevo.style.display === "block") puntoNuevo.style.display = "none";
            });

            
            document.addEventListener("click", (e) => {
                if (!e.target.closest(".divNotificaciones")) panelNoti.style.display = "none";
                if (!e.target.closest(".divGeneros")) {
                    menuGen.style.display = "none";
                    flecha.classList.remove("arriba");
                }
            });

            const sidebar = document.getElementById("sidebar");
            const btnLista = document.querySelector(".btnLista");
            const btnListaSidebar = document.querySelector(".btnListaSidebar");

            function toggleSidebar() {
                sidebar.style.display = sidebar.style.display === "block" ? "none" : "block";
            }
            btnLista.addEventListener("click", toggleSidebar);
            btnListaSidebar.addEventListener("click", toggleSidebar);

            // Likes
          

            document.getElementById("perfil").onclick = () => window.location.href = "perfil.html";
            document.getElementById("logo").onclick = () => window.location.href = "home.html";
        }

        async function inicializarLikes() {
            const corazon = document.getElementById("likes");
            const spanNumero = document.getElementById("likesNumero");

            let liked = false;
            let likesActuales = 0;

            try {
                // 1️⃣ obtener estado real del usuario
                const likeResp = await fetch(
                    `/api/Libros/parte/${idParte}/like`,
                    { headers }
                );
                const likeData = await likeResp.json();
                liked = likeData.liked;

                // 2️⃣ obtener contador real
                const parteResp = await fetch(
                    `/api/Libros/parte/${idParte}`,
                    { headers }
                );
                const parteData = await parteResp.json();
                likesActuales = parteData.likes;

            } catch {
                console.warn("Offline: usando estado local");
                likesActuales = parseInt(spanNumero.textContent) || 0;
            }

            // render inicial CONSISTENTE
            spanNumero.textContent = likesActuales;
            corazon.classList.toggle("latiendo", liked);

            corazon.onclick = async () => {
                // 🔒 BLOQUEO anti-doble click
                if (corazon.dataset.locked === "1") return;
                corazon.dataset.locked = "1";

                const accion = liked ? "unlike" : "like";

                // UI optimista
                liked = !liked;
                likesActuales += accion === "like" ? 1 : -1;
                likesActuales = Math.max(0, likesActuales);

                spanNumero.textContent = likesActuales;
                corazon.classList.toggle("latiendo", liked);

                try {
                    await fetch(`/api/Libros/parte/${idParte}/like`, {
                        method: "POST",
                        headers: {
                            ...headers,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ accion })
                    });
                } catch {
                    console.log("Like guardado offline");
                }

                corazon.dataset.locked = "0";
            };
        }


        window.addEventListener("online", () => {
            if ("serviceWorker" in navigator) {
                navigator.serviceWorker.ready.then(reg => {
                    reg.active?.postMessage({ tipo: "SYNC_LIKES" });
                });
            }
        });


        async function cargarFotoPerfilHome() {
            const img = document.getElementById("perfil");
            if (!img) return;

            const fallback = "fotoPerfil/perfil.png";

            /* =========================
               1️⃣ INTENTAR OFFLINE (IDB)
            ========================= */
            try {
                const db = await abrirPerfilDB();

                const pendientes = await new Promise(res => {
                    const tx = db.transaction("perfilPendiente", "readonly");
                    const store = tx.objectStore("perfilPendiente");
                    const r = store.getAll();
                    r.onsuccess = () => res(r.result || []);
                    r.onerror = () => res([]);
                });

                const fotoPendiente = pendientes
                    .filter(p => p.campo === "foto")
                    .sort((a, b) => b.fecha - a.fecha)[0];

                if (fotoPendiente?.blob) {
                    const url = URL.createObjectURL(fotoPendiente.blob);
                    img.onload = () => URL.revokeObjectURL(url);
                    img.src = url;
                    return; // ⛔ no seguir
                }

            } catch (e) {
                console.warn("No se pudo leer foto offline", e);
            }

            /* =========================
               2️⃣ ARCHIVO ESTÁTICO
            ========================= */
            const userId = localStorage.getItem("idUsuario");
            if (!userId) {
                img.src = fallback;
                return;
            }

            const bust = navigator.onLine ? `?t=${Date.now()}` : "";
            const url = `fotoPerfil/usuario_${userId}.webp${bust}`;

            img.src = url;

            /* =========================
               3️⃣ FALLBACK SEGURO
            ========================= */
            img.onerror = () => {
                img.src = fallback;
            };
        }
        window.addEventListener("online", async () => {
            await cargarFotoPerfilHome();
        });


        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.ready.then(reg => {
                reg.active?.postMessage({ tipo: "FORZAR_CACHE_LIMPIO" });
            });
        }

        function abrirPerfilDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open("perfilDB", 4);

                req.onupgradeneeded = e => {
                    const db = e.target.result;

                    if (!db.objectStoreNames.contains("perfil")) {
                        db.createObjectStore("perfil", { keyPath: "id" });
                    }

                    if (!db.objectStoreNames.contains("perfilPendiente")) {
                        db.createObjectStore("perfilPendiente", {
                            keyPath: "id",
                            autoIncrement: true
                        });
                    }
                };

                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }



        // Código para aumentar y disminuir el tamaño del texto
        const texto = document.getElementById("textoLectura");
        const btnAumentar = document.getElementById("btnAumentar");
        const btnDisminuir = document.getElementById("btnDisminuir");

        let tamañoActual = 13;
        const tamañoMin = 10;
        const tamañoMax = 20;

        function actualizarEstadoBotones() {
            // Aumentar
            if (tamañoActual >= tamañoMax) {
                btnAumentar.classList.add("btnDeshabilitado");
            } else {
                btnAumentar.classList.remove("btnDeshabilitado");
            }

            // Disminuir
            if (tamañoActual <= tamañoMin) {
                btnDisminuir.classList.add("btnDeshabilitado");
            } else {
                btnDisminuir.classList.remove("btnDeshabilitado");
            }
        }

        btnAumentar.addEventListener("click", () => {
            if (tamañoActual < tamañoMax) {
                tamañoActual += 1;
                texto.style.fontSize = tamañoActual + "px";
                actualizarEstadoBotones();
            }
        });

        btnDisminuir.addEventListener("click", () => {
            if (tamañoActual > tamañoMin) {
                tamañoActual -= 1;
                texto.style.fontSize = tamañoActual + "px";
                actualizarEstadoBotones();
            }
        });

        window.addEventListener("online", async () => {
            try {
                const resp = await fetch(
                    `https://myvexbooks2.duckdns.org/api/Libros/parte/${idParte}`,
                    { headers }
                );
                if (resp.ok) {
                    const parte = await resp.json();
                    document.getElementById("likesNumero").textContent = parte.likes ?? 0;
                }
            } catch { }
        });



        document.addEventListener("DOMContentLoaded", () => {
            cargarParte();
            cargarGeneros();
            configurarBuscador();
            configurarEventosEstaticos();
            cargarFotoPerfilHome();

        });
    </script>
</body>
</html>
