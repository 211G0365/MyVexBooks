
<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil</title>
    <link rel="stylesheet" href="estilos.css" />
</head>
<body>
    <header class="Encabezado">
        <img src="img/logo.png" class="logo" id="logo">


        <div class="DivBusqueda">
            <img src="img/lupa.png" class="lupa">
            <input type="text" placeholder="Buscar">
        </div>


        <div class="divGeneros">
            <button class="Generos" id="btnGeneros">
                <span class="flecha">&#9660;</span>
                <span>Géneros</span>
            </button>
            <div class="menuGeneros" id="menuGeneros">

            </div>
        </div>


        <div class="divNotificaciones">
            <div class="iconoCampana">
                <img src="img/notificacion.png" class="notificacion" id="btnNoti">
                <span class="puntoRojo" id="puntoNuevo"></span>
            </div>
            <div class="menuNotificaciones" id="panelNoti">
                <h3>Notificaciones</h3>
                <p class="sinMensajes" id="sinMensajes">No hay mensajes nuevos</p>
                <div class="listaMensajes" id="listaMensajes"></div>
            </div>
        </div>


        <div class="divPerfil">
            <img src="fotoPerfil/perfil.png" class="perfil" id="perfil">
            <div class="perfilMenu" id="perfilMenu">
                <button class="cerrarSesion" id="cerrarSesion">Cerrar sesión</button>
            </div>
        </div>
    </header>

    <main class="mainPerfil">
        <div class="fotoPerfil">
            <div class="circulo">
                <img src="fotoPerfil/perfil.png" class="imgPerfil">
                <img src="img/editar.png" class="lapiz" id="btnEditarFoto">
            </div>
        </div>

        <div class="infoPerfil">
            <div class="grupo">
                <label>Nombre de usuario:</label>
                <div class="inputConIcono">
                    <input type="text" id="inputNombre" disabled>
                    <img src="img/editar.png" class="btnEditarCampo" id="editarNombre">
                </div>
            </div>

            <div class="grupo">
                <label>Correo electrónico:</label>
                <div class="inputConIcono">
                    <input type="text" id="inputCorreo" disabled>
                    <img src="img/editar.png" class="btnEditarCampo" id="editarCorreo">
                </div>
            </div>

            <div class="grupo">
                <label>Contraseña:</label>
                <div class="inputConIcono">
                    <input type="password" id="inputPassword" placeholder="Cambiar contraseña" disabled>
                    <img src="img/libro-cerrado.png" id="iconoPassword" class="icono" alt="Mostrar/Ocultar">
                    <img src="img/editar.png" class="btnEditarCampo" id="editarPassword">
                </div>
            </div>

            <div class="botones" id="contenedorBotones" style="display:none;">
                <button class="guardar" id="btnGuardar">
                    <img src="img/book.png" class="imgGuardar">
                    Guardar
                </button>
                <button class="cancelar" id="btnCancelar">Cancelar</button>
            </div>
        </div>
    </main>

    <nav class="navMovil">
        <img src="img/home.png" id="btnHomeMovil">
        <img src="img/busqueda.png" id="btnBuscarMovil">
        <div class="iconoCampanaC">
            <img src="img/notificacion.png" id="btnNotiMovil">
            <span class="puntoRojo" id="puntoNuevoMovil"></span>
        </div>
    </nav>

    <script>
        const token = localStorage.getItem("token");
        if (!token) window.location.href = "index.html";

        const headers = { "Content-Type": "application/json", "Authorization": `Bearer ${token}` };


        const inputNombre = document.getElementById("inputNombre");
        const inputCorreo = document.getElementById("inputCorreo");
        const inputPassword = document.getElementById("inputPassword");
        const contBotones = document.getElementById("contenedorBotones");
        const btnGuardar = document.getElementById("btnGuardar");
        const btnCancelar = document.getElementById("btnCancelar");
        const inputFoto = document.createElement("input");
        inputFoto.type = "file";
        inputFoto.accept = "image/*";
        inputFoto.style.display = "none";
        document.body.appendChild(inputFoto);

        let valoresOriginales = { nombre: "", correo: "", password: "" };


        async function cargarPerfil() {


            const local = await cargarPerfilLocal();
            if (local) {
                inputNombre.value = local.nombre || "";
                inputCorreo.value = local.correo || "";

                valoresOriginales.nombre = local.nombre || "";
                valoresOriginales.correo = local.correo || "";
            }



            if (!navigator.onLine) return;


            try {
                const res = await fetch(
                    "https://myvexbooks2.duckdns.org/api/Usuarios/perfil",
                    { headers }
                );
                const perfil = await res.json();

                inputNombre.value = perfil.nombre;
                inputCorreo.value = perfil.correo;

                valoresOriginales.nombre = perfil.nombre;
                valoresOriginales.correo = perfil.correo;

                await guardarPerfilLocal({
                    nombre: perfil.nombre,
                    correo: perfil.correo
                });

            } catch {
                console.warn("Usando datos locales");
            }
        }




        async function cargarPerfilLocal() {
            const db = await abrirPerfilDB();
            const tx = db.transaction("perfil", "readonly");
            const store = tx.objectStore("perfil");

            return new Promise(resolve => {
                const req = store.get("perfil");
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => resolve(null);
            });
        }




        async function cargarFotoPerfil() {
            const img = document.querySelector(".imgPerfil");
            const imgHeader = document.getElementById("perfil");
            const fallback = "fotoPerfil/perfil.png";
            const usoOffline = await cargarFotoOfflinePendiente();
            if (usoOffline) return;


            const userId = localStorage.getItem("idUsuario");
            if (!userId) {
                img.src = fallback;
                imgHeader.src = fallback;
                return;
            }


            if (navigator.onLine) {
                const url = `fotoPerfil/usuario_${userId}.webp?t=${Date.now()}`;
                img.src = url;
                imgHeader.src = url;
            } else {
        
                const url = `fotoPerfil/usuario_${userId}.webp`;
                img.src = url;
                imgHeader.src = url;
            }

    
            img.onerror = () => img.src = fallback;
            imgHeader.onerror = () => imgHeader.src = fallback;
        }




        // SUBIR FOTO
        inputFoto.addEventListener("change", async function () {
            const archivo = this.files[0];
            if (!archivo) return;

            const imgPerfil = document.querySelector(".imgPerfil");
            const imgHeader = document.getElementById("perfil");
            const userKey = localStorage.getItem("correoUsuario");
            const fallback = "fotoPerfil/perfil.png";

 
            const previewURL = URL.createObjectURL(archivo);
            imgPerfil.src = previewURL;
            imgHeader.src = previewURL;

       
            if (!navigator.onLine) {
                const db = await abrirPerfilDB();
                const tx = db.transaction("perfilPendiente", "readwrite");
                const store = tx.objectStore("perfilPendiente");

                store.add({
                    id: Date.now(),
                    campo: "foto",
                    blob: archivo,        
                    type: archivo.type,
                    name: archivo.name,
                    fecha: Date.now()
                });

          


                if ("serviceWorker" in navigator && "SyncManager" in window) {
                    const reg = await navigator.serviceWorker.ready;
                    await reg.sync.register("sync-perfil");
                }

                alert("Foto guardada (offline). Se subirá al volver la conexión 📡");
                return;
            }



            try {
                const formData = new FormData();
                formData.append("foto", archivo);

                const resp = await fetch("/api/Usuarios/perfil/foto", {
                    method: "POST",
                    headers: {
                        Authorization: `Bearer ${token}`
                    },
                    body: formData
                });


                const data = await resp.json();
                if (!resp.ok) throw new Error(data?.error || "Error al subir foto");

                let nuevaFoto;

                if (data?.fotoURL) {
                    nuevaFoto = data.fotoURL.startsWith("http")
                        ? data.fotoURL
                        : "https://myvexbooks2.duckdns.org" + data.fotoURL;
                } else {
                    const userId = localStorage.getItem("idUsuario");
                    nuevaFoto = `fotoPerfil/usuario_${userId}.webp`;
                }

                const userId = localStorage.getItem("idUsuario");
                const bust = `?t=${Date.now()}`;

                imgPerfil.src = `fotoPerfil/usuario_${userId}.webp${bust}`;
                imgHeader.src = `fotoPerfil/usuario_${userId}.webp${bust}`;

                alert("Foto actualizada ✔");


                alert("Foto actualizada ✔");

            } catch (err) {
                console.error(err);
                const cached = localStorage.getItem("fotoPerfilURL_" + userKey);
                imgPerfil.src = cached || fallback;
                imgHeader.src = cached || fallback;


                alert("Error al subir foto. Se usó versión local.");
            }
        });


        document.getElementById("btnEditarFoto").onclick = () => inputFoto.click();


        function mostrarBotones() { contBotones.style.display = "flex"; }
        function habilitarEdicion(idInput) {
            const campo = document.getElementById(idInput);
            campo.disabled = false;
            campo.style.background = "#ffffff";
            campo.focus();
            mostrarBotones();
        }

        document.getElementById("editarNombre").onclick = () => habilitarEdicion("inputNombre");
        document.getElementById("editarCorreo").onclick = () => habilitarEdicion("inputCorreo");
        document.getElementById("editarPassword").onclick = () => habilitarEdicion("inputPassword");

        document.getElementById("iconoPassword").onclick = function () {
            if (inputPassword.type === "password") {
                inputPassword.type = "text";
                this.src = "img/libro-abierto.png";
            } else {
                inputPassword.type = "password";
                this.src = "img/libro-cerrado.png";
            }
        };

        btnCancelar.onclick = function () {
            inputNombre.value = valoresOriginales.nombre;
            inputCorreo.value = valoresOriginales.correo;
            inputPassword.value = valoresOriginales.password;

            inputNombre.disabled = true;
            inputCorreo.disabled = true;
            inputPassword.disabled = true;

            inputNombre.style.background = "#e5e5e5";
            inputCorreo.style.background = "#e5e5e5";
            inputPassword.style.background = "#e5e5e5";

            contBotones.style.display = "none";
        };

        btnGuardar.onclick = async function () {
            if (!inputNombre.disabled && inputNombre.value !== valoresOriginales.nombre) await actualizarCampo("nombre");
            if (!inputCorreo.disabled && inputCorreo.value !== valoresOriginales.correo) await actualizarCampo("correo");
            if (!inputPassword.disabled && inputPassword.value) await actualizarCampo("password");
        };

        async function actualizarCampo(campo) {
            const offline = !navigator.onLine;

            if (offline) {
                if (campo === "nombre") valoresOriginales.nombre = inputNombre.value;
                if (campo === "correo") valoresOriginales.correo = inputCorreo.value;

                await guardarPerfilLocal({
                    nombre: valoresOriginales.nombre,
                    correo: valoresOriginales.correo
                });

                await guardarCambioPendiente(
                    campo,
                    campo === "nombre" ? inputNombre.value : inputCorreo.value
                );

                await registrarSyncSeguro("sync-perfil");

                alert("Cambio guardado (offline) 📡");

                inputNombre.disabled = true;
                inputCorreo.disabled = true;
                inputPassword.disabled = true;

                inputNombre.style.background = "#e5e5e5";
                inputCorreo.style.background = "#e5e5e5";
                inputPassword.style.background = "#e5e5e5";

                contBotones.style.display = "none";
                inputPassword.value = "";
                return;
            }


            try {
                let url = "", body = {};
                if (campo === "nombre") { url = "https://myvexbooks2.duckdns.org/api/Usuarios/perfil/nombre"; body = { Nombre: inputNombre.value }; }
                else if (campo === "correo") { url = "https://myvexbooks2.duckdns.org/api/Usuarios/perfil/correo"; body = { Correo: inputCorreo.value }; }
                else if (campo === "password") { if (!inputPassword.value) return; url = "https://myvexbooks2.duckdns.org/api/Usuarios/perfil/contraseña"; body = { Actual: valoresOriginales.password, Nueva: inputPassword.value }; }

                let res;
                try {
                    res = await fetch(url, { method: "PUT", headers, body: JSON.stringify(body) });
                } catch {
                    alert("Sin conexión, se guardó localmente 📡");

                    await guardarCambioPendiente(campo, campo === "nombre"
                        ? inputNombre.value
                        : inputCorreo.value
                    );
                    return;
                }

                if (!res.ok) { const err = await res.json(); throw new Error(err.error || "Error al actualizar"); }

                if (campo === "nombre") valoresOriginales.nombre = inputNombre.value;
                if (campo === "correo") valoresOriginales.correo = inputCorreo.value;
                if (campo === "password") valoresOriginales.password = inputPassword.value;

                alert("Datos guardados correctamente ✔");
                inputNombre.disabled = true; inputCorreo.disabled = true; inputPassword.disabled = true;
                inputNombre.style.background = "#e5e5e5"; inputCorreo.style.background = "#e5e5e5"; inputPassword.style.background = "#e5e5e5";
                contBotones.style.display = "none";
                inputPassword.value = "";

            } catch (err) {
                console.error(err);
                alert("Error al actualizar: " + err.message);
            }
        }

        async function guardarCambioPendiente(campo, valor) {
            const db = await abrirPerfilDB();
            const tx = db.transaction("perfilPendiente", "readwrite");
            const store = tx.objectStore("perfilPendiente");

            const todos = await new Promise(resolve => {
                const req = store.getAll();
                req.onsuccess = () => resolve(req.result || []);
                req.onerror = () => resolve([]);
            });

            for (const item of todos) {
                if (item.campo === campo) {
                    store.delete(item.id); 
                }
            }

            store.add({
                campo,
                valor,
                fecha: Date.now()
            });
        }



        async function guardarPerfilLocal(datos) {
            const db = await abrirPerfilDB();
            const tx = db.transaction("perfil", "readwrite");
            const store = tx.objectStore("perfil");

            store.put({
                id: "perfil",
                nombre: datos.nombre,
                correo: datos.correo
            });
        }




        async function forzarSyncPerfil() {
            if (!navigator.onLine) return;

            await registrarSyncSeguro("sync-perfil");

            if ("serviceWorker" in navigator) {
                const reg = await navigator.serviceWorker.ready;
                reg.active?.postMessage({ tipo: "FORZAR_SYNC_PERFIL" });
            }
        }




        async function cargarGeneros() {
            try {
                const resp = await fetch("https://myvexbooks2.duckdns.org/api/Libros/generos", { headers });
                const generos = await resp.json();
                const menu = document.getElementById("menuGeneros");
                menu.innerHTML = "";
                generos.forEach(g => {
                    const btn = document.createElement("button");
                    btn.textContent = g;
                    btn.onclick = () => window.location.href = `./generos.html?genero=${encodeURIComponent(g)}`;
                    menu.appendChild(btn);
                });
            } catch (err) { console.error("Error cargando géneros:", err); }
        }


        function configurarBuscador() {
            const input = document.querySelector(".DivBusqueda input");
            let timeout = null;

            input.addEventListener("input", () => {
                const texto = input.value.trim();
                clearTimeout(timeout);
                if (!texto) {
                    const cont = document.getElementById("resultadosBusqueda");
                    if (cont) cont.remove();
                    return;
                }
                timeout = setTimeout(() => buscarLibros(texto), 350);
            });
        }

        async function buscarLibros(texto) {
            try {
                const resp = await fetch(`https://myvexbooks2.duckdns.org/api/Libros/buscar/${texto}`, { headers });
                const libros = await resp.json();
                mostrarResultadosBusqueda(libros);
            } catch (err) {
                console.error("Error buscando:", err);
            }
        }

        function mostrarResultadosBusqueda(libros) {
            let cont = document.getElementById("resultadosBusqueda");
            if (!cont) {
                cont = document.createElement("div");
                cont.id = "resultadosBusqueda";
                cont.style.padding = "20px";
                cont.style.background = "white";
                cont.style.border = "1px solid #ccc";
                cont.style.margin = "20px";
                cont.style.borderRadius = "10px";
                document.querySelector("main").prepend(cont);
            }
            cont.innerHTML = "<h2>Resultados</h2>";
            if (!libros.length) { cont.innerHTML += "<p>No hay resultados.</p>"; return; }
            libros.forEach(l => {
                cont.innerHTML += `
                            <div style="display:flex; gap:15px; margin-bottom:10px; cursor:pointer"
                                 onclick="window.location.href='Libro.html?id=${l.idLibro}'">
                                <img src="${l.portadaURL}" style="width:60px; height:90px; object-fit:cover">
                                <div>
                                    <p><b>${l.titulo}</b></p>
                                    <p>${l.autor}</p>
                                    <p style="font-size:12px; opacity:0.7">${l.genero}</p>
                                </div>
                            </div>`;
            });
        }


        document.getElementById("btnGeneros").addEventListener("click", () => {
            const menu = document.getElementById("menuGeneros");
            menu.style.display = menu.style.display === "grid" ? "none" : "grid";
            document.querySelector(".flecha").classList.toggle("arriba");
        });

        document.getElementById("btnNoti").addEventListener("click", () => {
            const panel = document.getElementById("panelNoti");
            const punto = document.getElementById("puntoNuevo");
            const isAbierto = panel.style.display === "block";
            panel.style.display = isAbierto ? "none" : "block";

           
            if (!isAbierto) {
                localStorage.setItem("notiPendientes", "false");
                if (punto) punto.style.display = "none";
            }
        });

        document.addEventListener("click", (e) => {
            if (!e.target.closest(".divNotificaciones")) document.getElementById("panelNoti").style.display = "none";
            if (!e.target.closest(".divGeneros")) {
                document.getElementById("menuGeneros").style.display = "none";
                document.querySelector(".flecha").classList.remove("arriba");
            }
        });

        const perfilMenu = document.getElementById("perfilMenu");
        document.getElementById("perfil").addEventListener("click", () => perfilMenu.classList.toggle("activo"));

        document.getElementById("cerrarSesion").onclick = async function () {
            if (confirm("¿Deseas cerrar sesión?")) {
                const userKey = localStorage.getItem("correoUsuario");
                localStorage.removeItem("token");
                localStorage.removeItem("correoUsuario");
                localStorage.removeItem("fotoPerfilURL_" + userKey);

                const db = await abrirPerfilDB();
                const tx = db.transaction("perfil", "readwrite");
                tx.objectStore("perfil").delete("perfil");


                window.location.href = "index.html?ts=" + Date.now();
                const fotoCache = await caches.open("foto-perfil-cache-v2");
                fotoCache.keys().then(keys => {
                    keys.forEach(k => fotoCache.delete(k));
                });

            }
        };



        function abrirPerfilDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open("perfilDB", 4);

                req.onupgradeneeded = e => {
                    const db = e.target.result;

                    if (!db.objectStoreNames.contains("perfil")) {
                        db.createObjectStore("perfil", { keyPath: "id" });
                    }

                    if (!db.objectStoreNames.contains("perfilPendiente")) {
                        db.createObjectStore("perfilPendiente", {
                            keyPath: "id",
                            autoIncrement: true
                        });
                    }
                };

                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }




        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.ready.then(reg => {
                reg.active?.postMessage({
                    tipo: "TOKEN",
                    token: token
                });
            });
        }

        async function registrarSyncSeguro(tag) {
            if (!("serviceWorker" in navigator)) return;
            if (!("SyncManager" in window)) {
                console.warn("SyncManager no soportado");
                return;
            }

            try {
                const reg = await navigator.serviceWorker.ready;
                await reg.sync.register(tag);
                console.log("Background Sync registrado:", tag);
            } catch (e) {
                console.warn("Background Sync NO permitido en este navegador");
            }
        }

        window.addEventListener("online", async () => {
            await forzarSyncPerfil();
            const usoOffline = await cargarFotoOfflinePendiente();
            if (!usoOffline) await cargarFotoPerfil();
        });



        window.addEventListener("load", async () => {
            if (navigator.onLine) {
                await forzarSyncPerfil();
            }
        });

        async function cargarFotoOfflinePendiente() {
            const db = await abrirPerfilDB();

            const pendientes = await new Promise(res => {
                const tx = db.transaction("perfilPendiente", "readonly");
                const store = tx.objectStore("perfilPendiente");
                const r = store.getAll();
                r.onsuccess = () => res(r.result || []);
            });

            const fotoPendiente = pendientes
                .filter(p => p.campo === "foto")
                .sort((a, b) => b.fecha - a.fecha)[0];

            const img = document.querySelector(".imgPerfil");
            const imgHeader = document.getElementById("perfil");

            if (fotoPendiente?.blob) {
                const url = URL.createObjectURL(fotoPendiente.blob);
                img.onload = () => URL.revokeObjectURL(url);
                imgHeader.onload = () => URL.revokeObjectURL(url);
                img.src = url;
                imgHeader.src = url;
                return true;
            }

            return false;
        }



        navigator.serviceWorker?.addEventListener("message", e => {
            if (e.data?.tipo === "FOTO_ACTUALIZADA") {
                cargarFotoPerfil();
            }
        });






        // Navegación
        document.getElementById("logo").onclick = () => window.location.href = "home.html";
        document.getElementById("btnHomeMovil").onclick = () => window.location.href = "home.html";
        document.getElementById("btnBuscarMovil").onclick = () => window.location.href = "busqueda.html";
        document.getElementById("btnNotiMovil").onclick = () => window.location.href = "notificaciones.html";


        //notis
        function manejarMensajeSW(event) {
            if (!event.data) return;

            switch (event.data.tipo) {
                case "RECIBIDA":
                    console.log("Notificación recibida desde SW:", event.data);

                 
                    const puntoPC = document.getElementById("puntoNuevo");
                    if (puntoPC) puntoPC.style.display = "block";


                    marcarPuntoRojoMovil();

                    const notisGuardadas = JSON.parse(localStorage.getItem("notificaciones") || "[]");
                    const existe = notisGuardadas.some(n =>
                        n.titulo === event.data.titulo &&
                        n.mensaje === event.data.mensaje &&
                        n.idLibro === event.data.idLibro
                    );
                    if (!existe) {
                        notisGuardadas.unshift(event.data);
                        localStorage.setItem("notificaciones", JSON.stringify(notisGuardadas));
                    }
                    break;

                case "FOTO_ACTUALIZADA":
                    cargarFotoPerfilHome();
                    break;

                default:
                    console.warn("Mensaje SW no manejado:", event.data);
            }
        }


        async function registrar() {
            try {
                if (!("serviceWorker" in navigator)) return;

                const registro = await navigator.serviceWorker.register("/sw.js");

                const permission = await Notification.requestPermission();
                if (permission !== "granted") return;

                const response = await fetch(
                    "https://myvexbooks2.duckdns.org/api/notificaciones/publickey"
                );

                if (!response.ok) throw new Error("No se pudo obtener la public key");

                const llave = await response.text();
                if (!llave) return;

                let subscription = await registro.pushManager.getSubscription();

                if (!subscription) {
                    subscription = await registro.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array(llave)
                    });
                }

                await fetch("https://myvexbooks2.duckdns.org/api/notificaciones", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(subscription)
                });

                navigator.serviceWorker.removeEventListener("message", manejarMensajeSW);
                navigator.serviceWorker.addEventListener("message", manejarMensajeSW);

            } catch (err) {
                console.warn("Registro de notificaciones omitido:", err.message);
            }
        }




        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');

            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);

            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        function mostrarNotificacionEnPanel({ titulo, mensaje, idLibro, portada }, guardar = true) {
            const lista = document.getElementById("listaMensajes");
            const sinMensajes = document.getElementById("sinMensajes");
            const punto = document.getElementById("puntoNuevo");

            if (!lista) return;
            if (sinMensajes) sinMensajes.style.display = "none";

            const div = document.createElement("div");
            div.className = "notificacionItem";
            div.style.display = "flex";
            div.style.alignItems = "center";
            div.style.cursor = "pointer";
            div.style.marginBottom = "6px";
            div.style.padding = "6px";
            div.style.borderRadius = "12px";
            div.style.backgroundColor = "#fff";
            div.style.boxShadow = "0 1px 3px rgba(0,0,0,0.1)";
            div.style.transition = "background 0.2s";
            div.onmouseover = () => div.style.backgroundColor = "#f5f5f5";
            div.onmouseleave = () => div.style.backgroundColor = "#fff";

            div.innerHTML = `
        <img src="${portada || 'img/logo.png'}" 
             class="notiPortada" 
             style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; margin-right: 10px;" />
        <div class="notiTexto" style="flex:1; margin:1px;">
            <p class="notiTitulo" style="margin:0; font-weight:bold; font-size:0.9rem;">${titulo}</p>
            <p class="notiMensaje" style="margin:0; font-size:0.8rem; color:#555;">${mensaje}</p>
        </div>
    `;

            div.onclick = () => {

                if (idLibro) {
                    let notis = JSON.parse(localStorage.getItem("notificaciones") || "[]");
                    notis = notis.filter(n => n.idLibro !== idLibro);
                    localStorage.setItem("notificaciones", JSON.stringify(notis));
                }

                localStorage.setItem("notiPendientes", "false");
                if (punto) punto.style.display = "none";


                if (idLibro) window.location.href = `libro.html?id=${idLibro}`;
                else window.location.href = "home.html";
            };
            lista.prepend(div);

            if (guardar) {
                const notisGuardadas = JSON.parse(localStorage.getItem("notificaciones") || "[]");
                const existe = notisGuardadas.some(n => n.titulo === titulo && n.mensaje === mensaje && n.idLibro === idLibro);
                if (!existe) {
                    notisGuardadas.unshift({ titulo, mensaje, idLibro, portada });
                    localStorage.setItem("notificaciones", JSON.stringify(notisGuardadas));
                }

                if (punto) {
                    punto.style.display = "block";
                    localStorage.setItem("notiPendientes", "true");
                }
            }
        }

        function restaurarNotificacionesGuardadas() {
            const lista = document.getElementById("listaMensajes");
            const sinMensajes = document.getElementById("sinMensajes");
            if (!lista) return;

            const notis = JSON.parse(localStorage.getItem("notificaciones") || "[]");
            lista.innerHTML = "";

            if (notis.length === 0) {
                if (sinMensajes) sinMensajes.style.display = "block";
                return;
            } else {
                if (sinMensajes) sinMensajes.style.display = "none";
            }

            notis.forEach(noti => mostrarNotificacionEnPanel(noti, false)); 
        }



        function marcarNotificacionesPendientes() {
            localStorage.setItem("notiPendientes", "true");
        }


        function restaurarEstadoNotificaciones() {
            const puntoPC = document.getElementById("puntoNuevo");
            const puntoMovil = document.getElementById("puntoNuevoMovil");
            const pendientes = localStorage.getItem("notiPendientes") === "true";

            if (puntoPC) puntoPC.style.display = pendientes ? "block" : "none";
            if (puntoMovil) puntoMovil.style.display = pendientes ? "block" : "none";
        }

        function marcarPuntoRojoMovil() {
            const puntoMovil = document.getElementById("puntoNuevoMovil");
            if (puntoMovil) puntoMovil.style.display = "block";
            localStorage.setItem("notiPendientes", "true");
        }

        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.ready.then(reg => {
                navigator.serviceWorker.removeEventListener("message", manejarMensajeSW);
                navigator.serviceWorker.addEventListener("message", manejarMensajeSW);
            });
        }
        

        document.addEventListener("DOMContentLoaded", async () => {
            await registrar();
            restaurarEstadoNotificaciones();
            restaurarNotificacionesGuardadas();
            await cargarFotoPerfil();
            await cargarPerfil();
            await cargarGeneros();
            configurarBuscador();
        });


    </script>
</body>
</html>

