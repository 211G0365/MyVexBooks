<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Libro</title>
    <link rel="stylesheet" href="estilos.css" />
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="iconos/512.png" />
</head>
<body>

    <header class="Encabezado">
        <img src="img/logo.png" class="logo" id="logo">


        <div class="DivBusqueda">
            <img src="img/lupa.png" class="lupa">
            <input type="text" id="inputBusqueda" placeholder="Buscar">
        </div>


        <div class="divGeneros">
            <button class="Generos" id="btnGeneros">
                <span class="flecha">&#9660;</span>
                <span>Géneros</span>
            </button>
            <div class="menuGeneros" id="menuGeneros"></div>
        </div>


        <div class="divNotificaciones">
            <div class="iconoCampana">
                <img src="img/notificacion.png" class="notificacion" id="btnNoti">
                <span class="puntoRojo" id="puntoNuevo"></span>
            </div>
            <div class="menuNotificaciones" id="panelNoti">
                <h3>Notificaciones</h3>
                <p class="sinMensajes" id="sinMensajes">No hay mensajes nuevos</p>
                <div class="listaMensajes" id="listaMensajes"></div>
            </div>
        </div>

        <img src="fotoPerfil/perfil.png" class="perfil" id="perfil">
    </header>

    <main class="mainLibro">


        <div class="libroElegido">
            <img id="imgPortada" class="bookE">

            <div class="infoLibroE">
                <p class="tituloE" id="tituloLibro"></p>
                <p class="autorE" id="autorLibro"></p>

                <div class="infoE">
                    <span class="spanLibroE">
                        <img src="img/likes.png" class="likesE" />
                        <span id="likesLibro">0</span>
                    </span>
                    <span class="spanLibroE">
                        <img src="img/lista.png" class="listaE" />
                        <span id="partesLibro"></span>
                    </span>
                </div>

                <div class="divLeer">
                    <button class="leer" id="btnLeer">
                        <img src="img/book.png" class="imgLeer">
                        Leer
                    </button>
                </div>
            </div>
        </div>


        <div class="divLibroSC">
            <div class="divBtnSC">
                <button class="btnSinopsis activo" data-tab="sinopsis">Sinopsis</button>
                <button class="btnContenido" data-tab="contenido">Contenido</button>
            </div>

            <div class="divSinopsis activo" id="sinopsis"></div>
            <div class="divContenido" id="contenido"><ul id="listaCapitulos"></ul></div>
        </div>

    </main>
    <nav class="navMovil">
        <img src="img/home.png" id="btnHomeMovil">
        <img src="img/busqueda.png" id="btnBuscarMovil">
        <div class="iconoCampanaC">
            <img src="img/notificacion.png" id="btnNotiMovil">
            <span class="puntoRojo" id="puntoNuevoMovil"></span>
        </div>
    </nav>

    <script>

        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("/sw.js")
                .then(() => console.log("SW registrado"))
                .catch(err => console.error(err));
        }

        const token = localStorage.getItem("token");
        if (!token) window.location.href = "index.html";

        const headers = {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
        };


        const params = new URLSearchParams(window.location.search);
        const idLibro = params.get("id");


        async function cargarLibro() {
            try {
                const resp = await fetch(`https://myvexbooks2.duckdns.org/api/Libros/${idLibro}`, { headers });
                const libro = await resp.json();

                document.getElementById("imgPortada").src = libro.portadaURL || "img/libro1.jpg";
                document.getElementById("tituloLibro").textContent = libro.titulo;
                document.getElementById("autorLibro").textContent = libro.autor;
                let likesBase = libro.likes || 0;

                // 🔁 ajustar con likes offline
                const pendientes = await obtenerLikesPendientesPorLibro(libro.partes || []);

                pendientes.forEach(p => {
                    if (p.accion === "like") likesBase += 1;
                    if (p.accion === "unlike") likesBase -= 1;
                });
                likesBase = Math.max(0, likesBase);

                document.getElementById("likesLibro").textContent = likesBase;

                document.getElementById("partesLibro").textContent = `${libro.partes?.length || 0} partes`;
                document.getElementById("sinopsis").innerHTML = `<p>${libro.sinopsis}</p>`;

                // Contenido
                const lista = document.getElementById("listaCapitulos");
                lista.innerHTML = "";
                libro.partes?.forEach((p) => {
                    const li = document.createElement("li");

                    const titulo =
                        p.nombreParte && p.nombreParte.trim() !== ""
                            ? p.nombreParte
                            : `Parte ${p.numeroParte}`;

                    li.textContent = `${p.numeroParte}. ${titulo}`;
                    li.onclick = () => window.location.href = `lectura.html?id=${p.idParte}`;
                    lista.appendChild(li);

                    console.log(libro.partes);
                });



                document.getElementById("btnLeer").onclick = () => {
                    if (libro.partes?.length > 0)
                        window.location.href = `lectura.html?id=${libro.partes[0].idParte}`;
                };

            } catch (err) {
                console.error("Error cargando libro:", err);
            }
        }

        window.addEventListener("online", () => {
            cargarLibro();
        });


        async function cargarGeneros() {
            try {
                const resp = await fetch("https://myvexbooks2.duckdns.org/api/Libros/generos", { headers });
                const generos = await resp.json();

                const menu = document.getElementById("menuGeneros");
                menu.innerHTML = "";
                generos.forEach(g => {
                    const btn = document.createElement("button");
                    btn.textContent = g;
                    btn.onclick = () => window.location.href = `./generos.html?genero=${encodeURIComponent(g)}`;
                    menu.appendChild(btn);
                });
            } catch (err) {
                console.error("Error generos:", err);
            }
        }


        function configurarBuscador() {
            const input = document.getElementById("inputBusqueda");
            let timeout = null;

            input.addEventListener("input", () => {
                const texto = input.value.trim();

                clearTimeout(timeout);
                if (!texto) {
                    const cont = document.getElementById("resultadosBusqueda");
                    if (cont) cont.remove();
                    return;
                }

                timeout = setTimeout(() => buscarLibros(texto), 300);
            });
        }

        async function buscarLibros(texto) {
            try {
                const resp = await fetch(`https://myvexbooks2.duckdns.org/api/Libros/buscar/${texto}`, { headers });
                const libros = await resp.json();
                mostrarResultadosBusqueda(libros);
            } catch (err) {
                console.error("Error buscando:", err);
            }
        }

        function mostrarResultadosBusqueda(libros) {
            let cont = document.getElementById("resultadosBusqueda");
            if (!cont) {
                cont = document.createElement("div");
                cont.id = "resultadosBusqueda";
                document.querySelector("main").prepend(cont);
            }
            cont.innerHTML = "<h2>Resultados</h2>";
            if (!libros.length) { cont.innerHTML += "<p>No hay resultados.</p>"; return; }
            libros.forEach(l => {
                cont.innerHTML += `
                         <div class="divRB"
                              onclick="window.location.href='libro.html?id=${l.idLibro}'">
                             <img class="imgRB" src="${l.portadaURL}" >
                             <div class="divBookRB">
                                 <p><b>${l.titulo}</b></p>
                                 <p class="pAutorRB">${l.autor}</p>
                                 <p class="pGeneroRB">${l.genero}</p>
                             </div>
                         </div>`;
            });
        }



        function configurarEventosEstaticos() {
            const btnGen = document.getElementById("btnGeneros");
            const menuGen = document.getElementById("menuGeneros");
            const flecha = document.querySelector(".flecha");

            btnGen.addEventListener("click", () => {
                menuGen.style.display = menuGen.style.display === "grid" ? "none" : "grid";
                flecha.classList.toggle("arriba");
            });

            const btnNoti = document.getElementById("btnNoti");
            const panelNoti = document.getElementById("panelNoti");
            const puntoNuevo = document.getElementById("puntoNuevo");

            btnNoti.addEventListener("click", () => {
                const isAbierto = panelNoti.style.display === "block";
                panelNoti.style.display = isAbierto ? "none" : "block";

                if (!isAbierto) {
                    localStorage.setItem("notiPendientes", "false");
                    puntoNuevo.style.display = "none";
                }
            });

            document.addEventListener("click", (e) => {
                if (!e.target.closest(".divNotificaciones")) panelNoti.style.display = "none";
                if (!e.target.closest(".divGeneros")) {
                    menuGen.style.display = "none";
                    flecha.classList.remove("arriba");
                }
            });

            document.getElementById("perfil").onclick = () => window.location.href = "perfil.html";
            document.getElementById("logo").onclick = () => window.location.href = "home.html";
        }


        function configurarTabs() {
            const botones = document.querySelectorAll(".divBtnSC button");
            const sinopsis = document.getElementById("sinopsis");
            const contenido = document.getElementById("contenido");

            botones.forEach(btn => {
                btn.addEventListener("click", () => {


                    botones.forEach(b => b.classList.remove("activo"));


                    btn.classList.add("activo");
                    if (btn.dataset.tab === "sinopsis") {
                        sinopsis.classList.add("activo");
                        contenido.classList.remove("activo");
                    } else {
                        contenido.classList.add("activo");
                        sinopsis.classList.remove("activo");
                    }
                });
            });
        }

        async function cargarFotoPerfilHome() {
            const img = document.getElementById("perfil");
            if (!img) return;

            const fallback = "fotoPerfil/perfil.png";
            try {
                const db = await abrirPerfilDB();

                const pendientes = await new Promise(res => {
                    const tx = db.transaction("perfilPendiente", "readonly");
                    const store = tx.objectStore("perfilPendiente");
                    const r = store.getAll();
                    r.onsuccess = () => res(r.result || []);
                    r.onerror = () => res([]);
                });

                const fotoPendiente = pendientes
                    .filter(p => p.campo === "foto")
                    .sort((a, b) => b.fecha - a.fecha)[0];

                if (fotoPendiente?.blob) {
                    const url = URL.createObjectURL(fotoPendiente.blob);
                    img.onload = () => URL.revokeObjectURL(url);
                    img.src = url;
                    return;
                }

            } catch (e) {
                console.warn("No se pudo leer foto offline", e);
            }

            const userId = localStorage.getItem("idUsuario");
            if (!userId) {
                img.src = fallback;
                return;
            }

            const bust = navigator.onLine ? `?t=${Date.now()}` : "";
            const url = `fotoPerfil/usuario_${userId}.webp${bust}`;

            img.src = url;
            img.onerror = () => {
                img.src = fallback;
            };
        }
        window.addEventListener("online", async () => {
            await cargarFotoPerfilHome();
        });

        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.ready.then(reg => {
                reg.active?.postMessage({ tipo: "FORZAR_CACHE_LIMPIO" });
            });
        }

        function abrirPerfilDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open("perfilDB", 4);

                req.onupgradeneeded = e => {
                    const db = e.target.result;

                    if (!db.objectStoreNames.contains("perfil")) {
                        db.createObjectStore("perfil", { keyPath: "id" });
                    }

                    if (!db.objectStoreNames.contains("perfilPendiente")) {
                        db.createObjectStore("perfilPendiente", {
                            keyPath: "id",
                            autoIncrement: true
                        });
                    }
                };

                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }

        function abrirLikesDB() {
            return new Promise(resolve => {
                const req = indexedDB.open("likesDB", 5);
                req.onsuccess = () => resolve(req.result);
            });
        }

        async function obtenerLikesPendientesPorLibro(partesLibro) {
            try {
                const db = await abrirLikesDB();
                const tx = db.transaction("pendientes", "readonly");
                const store = tx.objectStore("pendientes");

                const pendientes = await new Promise(res => {
                    const r = store.getAll();
                    r.onsuccess = () => res(r.result || []);
                    r.onerror = () => res([]);
                });

                const idsPartes = new Set(partesLibro.map(p => String(p.idParte)));

                return pendientes.filter(p =>
                    idsPartes.has(String(p.idParte))
                );
            } catch {
                return [];
            }
        }
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.addEventListener("message", e => {
                if (e.data?.tipo === "LIKE_CAMBIO") {
                    actualizarLikesLibro(e.data.accion);
                }
            });
        }

        function actualizarLikesLibro(accion) {
            const span = document.getElementById("likesLibro");
            let total = parseInt(span.textContent) || 0;

            total += accion === "like" ? 1 : -1;
            span.textContent = Math.max(0, total);
        }


        //notis
        function manejarMensajeSW(event) {
            if (!event.data) return;

            switch (event.data.tipo) {
                case "RECIBIDA":
                    console.log("Notificación recibida desde SW:", event.data);

                    const puntoPC = document.getElementById("puntoNuevo");
                    if (puntoPC) puntoPC.style.display = "block";

                    marcarPuntoRojoMovil();

                    const notisGuardadas = JSON.parse(localStorage.getItem("notificaciones") || "[]");
                    const existe = notisGuardadas.some(n =>
                        n.titulo === event.data.titulo &&
                        n.mensaje === event.data.mensaje &&
                        n.idLibro === event.data.idLibro
                    );
                    if (!existe) {
                        notisGuardadas.unshift(event.data);
                        localStorage.setItem("notificaciones", JSON.stringify(notisGuardadas));
                    }
                    break;

                case "FOTO_ACTUALIZADA":
                    cargarFotoPerfilHome();
                    break;

                default:
                    console.warn("Mensaje SW no manejado:", event.data);
            }
        }

        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.ready.then(() => {
                navigator.serviceWorker.removeEventListener("message", manejarMensajeSW);
                navigator.serviceWorker.addEventListener("message", manejarMensajeSW);
            });
        }


        async function registrar() {
            try {
                if (!("serviceWorker" in navigator)) return;

                const registro = await navigator.serviceWorker.register("/sw.js");

                const permission = await Notification.requestPermission();
                if (permission !== "granted") return;

                const response = await fetch(
                    "https://myvexbooks2.duckdns.org/api/notificaciones/publickey"
                );

                if (!response.ok) throw new Error("No se pudo obtener la public key");

                const llave = await response.text();
                if (!llave) return;

                let subscription = await registro.pushManager.getSubscription();

                if (!subscription) {
                    subscription = await registro.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array(llave)
                    });
                }

                await fetch("https://myvexbooks2.duckdns.org/api/notificaciones", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(subscription)
                });

                navigator.serviceWorker.removeEventListener("message", manejarMensajeSW);
                navigator.serviceWorker.addEventListener("message", manejarMensajeSW);

            } catch (err) {
                console.warn("Registro de notificaciones omitido:", err.message);
            }
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');

            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);

            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        function mostrarNotificacionEnPanel({ titulo, mensaje, idLibro, portada }, guardar = true) {
            const lista = document.getElementById("listaMensajes");
            const sinMensajes = document.getElementById("sinMensajes");
            const punto = document.getElementById("puntoNuevo");

            if (!lista) return;

            if (sinMensajes) sinMensajes.style.display = "none";

            const div = document.createElement("div");
            div.className = "notificacionItem";
            div.style.display = "flex";
            div.style.alignItems = "center";
            div.style.cursor = "pointer";
            div.style.marginBottom = "6px";
            div.style.padding = "6px";
            div.style.borderRadius = "12px";
            div.style.backgroundColor = "#fff";
            div.style.boxShadow = "0 1px 3px rgba(0,0,0,0.1)";
            div.style.transition = "background 0.2s";
            div.onmouseover = () => div.style.backgroundColor = "#f5f5f5";
            div.onmouseleave = () => div.style.backgroundColor = "#fff";

            div.innerHTML = `
            <img src="${portada || 'img/logo.png'}"
                 class="notiPortada"
                 style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; margin-right: 10px;" />
            <div class="notiTexto" style="flex:1; margin:1px;">
                <p class="notiTitulo" style="margin:0; font-weight:bold; font-size:0.9rem;">${titulo}</p>
                <p class="notiMensaje" style="margin:0; font-size:0.8rem; color:#555;">${mensaje}</p>
            </div>
        `;

            div.onclick = () => {
                if (idLibro) {
                    let notis = JSON.parse(localStorage.getItem("notificaciones") || "[]");
                    notis = notis.filter(n => n.idLibro !== idLibro);
                    localStorage.setItem("notificaciones", JSON.stringify(notis));
                }

                localStorage.setItem("notiPendientes", "false");
                if (punto) punto.style.display = "none";

                if (idLibro) window.location.href = `libro.html?id=${idLibro}`;
                else window.location.href = "home.html";
            };

            lista.prepend(div);


            if (guardar) {
                const notisGuardadas = JSON.parse(localStorage.getItem("notificaciones") || "[]");
                const existe = notisGuardadas.some(n => n.titulo === titulo && n.mensaje === mensaje && n.idLibro === idLibro);
                if (!existe) {
                    notisGuardadas.unshift({ titulo, mensaje, idLibro, portada });
                    localStorage.setItem("notificaciones", JSON.stringify(notisGuardadas));
                }

                if (punto) {
                    punto.style.display = "block";
                    localStorage.setItem("notiPendientes", "true");
                }
            }
        }

        function restaurarNotificacionesGuardadas() {
            const lista = document.getElementById("listaMensajes");
            const sinMensajes = document.getElementById("sinMensajes");
            if (!lista) return;

            const notis = JSON.parse(localStorage.getItem("notificaciones") || "[]");
            lista.innerHTML = "";

            if (notis.length === 0) {
                if (sinMensajes) sinMensajes.style.display = "block";
                return;
            } else {
                if (sinMensajes) sinMensajes.style.display = "none";
            }

            notis.forEach(noti => mostrarNotificacionEnPanel(noti, false)); 
        }



        function marcarNotificacionesPendientes() {
            localStorage.setItem("notiPendientes", "true");
        }

        function restaurarEstadoNotificaciones() {
            const puntoPC = document.getElementById("puntoNuevo");
            const puntoMovil = document.getElementById("puntoNuevoMovil");
            const pendientes = localStorage.getItem("notiPendientes") === "true";

            if (puntoPC) puntoPC.style.display = pendientes ? "block" : "none";
            if (puntoMovil) puntoMovil.style.display = pendientes ? "block" : "none";
        }

    
        function marcarPuntoRojoMovil() {
            const puntoMovil = document.getElementById("puntoNuevoMovil");
            if (puntoMovil) puntoMovil.style.display = "block";
            localStorage.setItem("notiPendientes", "true");
        }


        const btnNotiMovil = document.getElementById("btnNotiMovil");
        btnNotiMovil.onclick = () => {
  
            localStorage.setItem("notiPendientes", "false");
            restaurarEstadoNotificaciones();

            window.location.href = "notificaciones.html";
        };

    

        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.ready.then(reg => {
                navigator.serviceWorker.removeEventListener("message", manejarMensajeSW);
                navigator.serviceWorker.addEventListener("message", manejarMensajeSW);
            });
        }

        document.getElementById("perfil").onclick = function () {
            window.location.href = "perfil.html";
        }

        document.getElementById("logo").onclick = function () {
            window.location.href = "home.html";
        }


        document.getElementById("btnHomeMovil").onclick = () => {
            window.location.href = "home.html";
        };

        document.getElementById("btnBuscarMovil").onclick = () => {
            window.location.href = "busqueda.html";
        };

        document.getElementById("btnNotiMovil").onclick = () => {
            window.location.href = "notificaciones.html";
        };

        document.addEventListener("DOMContentLoaded", async () => {
            await registrar();
            restaurarEstadoNotificaciones();
            restaurarNotificacionesGuardadas();
            cargarFotoPerfilHome();
            cargarLibro();
            cargarGeneros();
            configurarBuscador();
            configurarEventosEstaticos();
            configurarTabs();
        });



    </script>

</body>
</html>
