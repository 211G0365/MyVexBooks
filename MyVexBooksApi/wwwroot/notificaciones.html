<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notificaciones</title>
    <link rel="stylesheet" href="estilos.css" />
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="iconos/512.png" />
</head>
<body>
    <header class="Encabezado">
        <img src="img/logo.png" class="logo" id="logo">
        <img src="fotoPerfil/perfil.png" class="perfil" id="perfil">
    </header>

    <main class="mainNotificaciones">
        <div class="menuNotificacionesC">
            <h3>Notificaciones</h3>
            <p class="sinMensajes" id="sinMensajes">No hay mensajes nuevos</p>
            <div class="listaMensajes" id="listaMensajes">
                <p class="conMensajes" id="conMensajes"></p>
            </div>
        </div>
    </main>

    <nav class="navMovil">
        <img src="img/home.png" id="btnHomeMovil">
        <img src="img/busqueda.png" id="btnBuscarMovil">
        <div class="iconoCampanaC">
            <img src="img/notificacion.png" id="btnNotiMovil">
            <span class="puntoRojo" id="puntoNuevo"></span>
        </div>
    </nav>
    
    <script>
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("/sw.js")
                .then(() => console.log("SW registrado"))
                .catch(err => console.error(err));
        }

        const token = localStorage.getItem("token");
        if (!token) window.location.href = "index.html";

        const headers = { "Content-Type": "application/json", "Authorization": `Bearer ${token}` };

        // Navegacion de paginas
        document.getElementById("perfil").onclick = function () {
            window.location.href = "perfil.html";
        }

        document.getElementById("logo").onclick = function () {
            window.location.href = "home.html";
        }

        // Navegación móvil
        document.getElementById("btnHomeMovil").onclick = () => {
            window.location.href = "home.html";
        };

        document.getElementById("btnBuscarMovil").onclick = () => {
            window.location.href = "busqueda.html";
        };

        document.getElementById("btnNotiMovil").onclick = () => {
            window.location.href = "notificaciones.html";
        };

        async function cargarFotoPerfilHome() {
            const img = document.getElementById("perfil");
            if (!img) return;

            const fallback = "fotoPerfil/perfil.png";

            /* =========================
               1️⃣ INTENTAR OFFLINE (IDB)
            ========================= */
            try {
                const db = await abrirPerfilDB();

                const pendientes = await new Promise(res => {
                    const tx = db.transaction("perfilPendiente", "readonly");
                    const store = tx.objectStore("perfilPendiente");
                    const r = store.getAll();
                    r.onsuccess = () => res(r.result || []);
                    r.onerror = () => res([]);
                });

                const fotoPendiente = pendientes
                    .filter(p => p.campo === "foto")
                    .sort((a, b) => b.fecha - a.fecha)[0];

                if (fotoPendiente?.blob) {
                    const url = URL.createObjectURL(fotoPendiente.blob);
                    img.onload = () => URL.revokeObjectURL(url);
                    img.src = url;
                    return; // ⛔ no seguir
                }

            } catch (e) {
                console.warn("No se pudo leer foto offline", e);
            }

            /* =========================
               2️⃣ ARCHIVO ESTÁTICO
            ========================= */
            const userId = localStorage.getItem("idUsuario");
            if (!userId) {
                img.src = fallback;
                return;
            }

            const bust = navigator.onLine ? `?t=${Date.now()}` : "";
            const url = `fotoPerfil/usuario_${userId}.webp${bust}`;

            img.src = url;

            /* =========================
               3️⃣ FALLBACK SEGURO
            ========================= */
            img.onerror = () => {
                img.src = fallback;
            };
        }
        window.addEventListener("online", async () => {
            await cargarFotoPerfilHome();
        });


        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.ready.then(reg => {
                reg.active?.postMessage({ tipo: "FORZAR_CACHE_LIMPIO" });
            });
        }

        function abrirPerfilDB() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open("perfilDB", 4);

                req.onupgradeneeded = e => {
                    const db = e.target.result;

                    if (!db.objectStoreNames.contains("perfil")) {
                        db.createObjectStore("perfil", { keyPath: "id" });
                    }

                    if (!db.objectStoreNames.contains("perfilPendiente")) {
                        db.createObjectStore("perfilPendiente", {
                            keyPath: "id",
                            autoIncrement: true
                        });
                    }
                };

                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });
        }
        // Función para mostrar una notificación en la lista
        function mostrarNotificacionEnPanel({ titulo, mensaje, idLibro, portada }) {
            const lista = document.getElementById("listaMensajes");
            const sinMensajes = document.getElementById("sinMensajes");

            if (sinMensajes) sinMensajes.style.display = "none";

            const div = document.createElement("div");
            div.className = "notificacionItem";

            div.innerHTML = `
        <img src="${portada || 'img/logo.png'}" class="notiPortada" />
        <div class="notiTexto">
            <p class="notiTitulo">${titulo}</p>
            <p class="notiMensaje">${mensaje}</p>
        </div>
    `;

            div.onclick = () => {
                if (idLibro) {
                    window.location.href = `libro.html?id=${idLibro}`;
                } else {
                    window.location.href = "home.html";
                }
            };

            lista.prepend(div);
        }

        // Registrar y recibir notificaciones desde el SW
        async function registrarNotificacionesMovil() {
            if (!("serviceWorker" in navigator)) return;

            const reg = await navigator.serviceWorker.ready;
            const permiso = await Notification.requestPermission();
            if (permiso !== "granted") return;

            const publicKey = await fetch("https://myvexbooks2.duckdns.org/api/Notificaciones/publickey").then(r => r.text());
            const subscription = await reg.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(publicKey)
            });

            await fetch("https://myvexbooks2.duckdns.org/api/Notificaciones", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(subscription)
            });

            navigator.serviceWorker.addEventListener("message", (event) => {
                if (event.data.tipo === "RECIBIDA") {
                    mostrarNotificacionEnPanel(event.data);
                }
            });
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            return Uint8Array.from([...rawData].map(c => c.charCodeAt(0)));
        }

        // Inicialización
        document.addEventListener("DOMContentLoaded", async () => {
            cargarFotoPerfilHome();
            await registrarNotificacionesMovil();
        });



   

    </script>
</body>
</html>