<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Géneros</title>
    <link rel="stylesheet" href="estilos.css" />
</head>
<body>
    <header class="Encabezado">
        <img src="img/logo.png" class="logo" id="logo">

        <div class="DivBusqueda">
            <img src="img/lupa.png" class="lupa">
            <input type="text" id="inputBusqueda" placeholder="Buscar">
        </div>

        <div class="divGeneros">
            <button class="Generos" id="btnGeneros">
                <span class="flecha">&#9660;</span>
                <span>Géneros</span>
            </button>
            <div class="menuGeneros" id="menuGeneros"></div>
        </div>

        <div class="divNotificaciones">
            <div class="iconoCampana">
                <img src="img/notificacion.png" class="notificacion" id="btnNoti">
                <span class="puntoRojo" id="puntoNuevo"></span>
            </div>
            <div class="menuNotificaciones" id="panelNoti">
                <h3>Notificaciones</h3>
                <p class="sinMensajes" id="sinMensajes">No hay mensajes nuevos</p>
                <div class="listaMensajes" id="listaMensajes"></div>
            </div>
        </div>

        <img src="fotoPerfil/perfil.png" class="perfil" id="perfil">
    </header>

    <main class="mainGeneros">
        <h3 id="tituloGenero">Género</h3>
        <div class="listaLibros" id="listaLibros"></div>
    </main>

    <script>
        const token = localStorage.getItem("token");
        if (!token) window.location.href = "index.html";

        const headers = { "Content-Type": "application/json", "Authorization": `Bearer ${token}` };

        // Obtener el género de la URL
        const params = new URLSearchParams(window.location.search);
        const generoSeleccionado = params.get("genero") || "Aventura";
        document.getElementById("tituloGenero").textContent = generoSeleccionado;



        async function cargarGeneros() {
            try {
                const resp = await fetch("https://myvexbooks2.duckdns.org/api/Libros/generos", { headers });
                const generos = await resp.json();
                const menu = document.getElementById("menuGeneros");
                menu.innerHTML = "";
                generos.forEach(g => {
                    const btn = document.createElement("button");
                    btn.textContent = g;
                    btn.onclick = () => {
                        window.location.href = `./generos.html?genero=${encodeURIComponent(g)}`;
                    };
                    menu.appendChild(btn);
                });
            } catch (err) {
               
            }
        }

        async function cargarLibrosPorGenero(genero) {
            try {
                const resp = await fetch(`https://myvexbooks2.duckdns.org/api/Libros/genero/${encodeURIComponent(genero)}`, { headers });
                const libros = await resp.json();
                renderizarLibros(libros);
            } catch (err) {
                console.error("Error cargando libros por género:", err);
            }
        }

        function renderizarLibros(libros) {
            const cont = document.getElementById("listaLibros");
            cont.innerHTML = "";
            libros.forEach(l => {
                const libroDiv = document.createElement("div");
                libroDiv.classList.add("libroG");
                libroDiv.innerHTML = `
                <img src="${l.portadaURL}" class="book" onerror="this.src='img/libro1.jpg'" style="background-color:blue">
                <div class="infoLibro">
                    <p class="titulo">${l.titulo}</p>
                    <p class="autor">${l.autor}</p>
                    <div class="info">
                        <span class="spanL">
                            <img src="img/likes.png" class="likes" />
                            ${l.likes || "0k"}
                        </span>
                        <span class="spanL">
                            <img src="img/lista.png" class="lista" />
                            ${l.partes?.length || 0} partes
                        </span>
                    </div>
                </div>
            `;
                libroDiv.onclick = () => window.location.href = `./libro.html?id=${l.idLibro}`;
                cont.appendChild(libroDiv);
            });
        }

    

        function configurarMenus() {
            const btn = document.getElementById("btnGeneros");
            const menu = document.getElementById("menuGeneros");
            const flecha = document.querySelector(".flecha");
            btn.addEventListener("click", () => {
                menu.style.display = menu.style.display === "grid" ? "none" : "grid";
                flecha.classList.toggle("arriba");
            });

            const btnNoti = document.getElementById("btnNoti");
            const panelNoti = document.getElementById("panelNoti");
            const puntoNuevo = document.getElementById("puntoNuevo");

            btnNoti.addEventListener("click", () => {
                panelNoti.style.display = panelNoti.style.display === "block" ? "none" : "block";
                if (puntoNuevo.style.display === "block") puntoNuevo.style.display = "none";
            });

            document.addEventListener("click", (e) => {
                if (!e.target.closest(".divNotificaciones")) panelNoti.style.display = "none";
                if (!e.target.closest(".divGeneros")) {
                    menu.style.display = "none";
                    flecha.classList.remove("arriba");
                }
            });

            document.getElementById("perfil").onclick = () => window.location.href = "perfil.html";
            document.getElementById("logo").onclick = () => window.location.href = "home.html";
        }


        // buscador
      
        function configurarBuscador() {
            const input = document.getElementById("inputBusqueda");
            let timeout = null;

            input.addEventListener("input", () => {
                const texto = input.value.trim().toLowerCase();
                clearTimeout(timeout);

                if (!texto) {
                    const cont = document.getElementById("resultadosBusqueda");
                    if (cont) cont.remove();
                    return;
                }

                timeout = setTimeout(() => buscarLibrosPorGenero(texto, generoSeleccionado), 350);
            });
        }


        async function buscarLibrosPorGenero(texto, genero) {
            try {
                const resp = await fetch(`https://myvexbooks2.duckdns.org/api/Libros/genero/${encodeURIComponent(genero)}`, { headers });
                let libros = await resp.json();

                libros = libros.filter(l =>
                    l.titulo.toLowerCase().includes(texto) ||
                    l.autor.toLowerCase().includes(texto)
                );

                mostrarResultadosBusqueda(libros);

            } catch (err) {
                console.error("Error buscando libros por género:", err);
            }
        }

        function mostrarResultadosBusqueda(libros) {
            let cont = document.getElementById("resultadosBusqueda");
            if (!cont) {
                cont = document.createElement("div");
                cont.id = "resultadosBusqueda";
                cont.style.padding = "20px";
                cont.style.background = "white";
                cont.style.border = "1px solid #ccc";
                cont.style.margin = "20px";
                cont.style.borderRadius = "10px";
                document.querySelector("main").prepend(cont);
            }
            cont.innerHTML = "<h2>Resultados</h2>";
            if (!libros.length) { cont.innerHTML += "<p>No hay resultados.</p>"; return; }
            libros.forEach(l => {
                cont.innerHTML += `
    <div style="display:flex; gap:15px; margin-bottom:10px; cursor:pointer"
         onclick="window.location.href='Libro.html?id=${l.idLibro}'">
        <img src="${l.portadaURL}" style="width:60px; height:90px; object-fit:cover">
        <div>
            <p><b>${l.titulo}</b></p>
            <p>${l.autor}</p>

            <p style="font-size:12px; opacity:0.7">${l.genero}</p>
        </div>
    </div>`;
            });
        }

        async function cargarFotoPerfilHome() {
            const img = document.getElementById("perfil");
            if (!img) return;

            try {
                const resp = await fetch("https://myvexbooks2.duckdns.org/api/Usuarios/perfil/foto", { headers });
                const data = await resp.json();

                const url = data?.fotoURL
                    ? (data.fotoURL.startsWith("http") ? data.fotoURL : "https://myvexbooks2.duckdns.org" + data.fotoURL)
                    : "fotoPerfil/perfil.png";
                img.src = url + "?t=" + Date.now();
                localStorage.setItem("fotoPerfilURL", url);

            } catch (err) {
                img.src = "fotoPerfil/perfil.png";
            }
        }






        // iniciar

        document.addEventListener("DOMContentLoaded", async () => {
            await cargarGeneros();
            await cargarLibrosPorGenero(generoSeleccionado);
            configurarMenus();
            configurarBuscador();
            cargarFotoPerfilHome(); 
        });
    </script>
</body>
</html>
